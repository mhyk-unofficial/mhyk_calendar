<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mhyk æ´»å‹•è³‡æ–™åº«</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root { 
            --main-purple: #7d6ba1; 
            --gacha-gold: #d4af37; 
            --reward-blue: #5b8ad2; 
            --bg-color: #fcf9f2; 
        }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background: var(--bg-color); margin: 0; padding: 20px; color: #333; line-height: 1.5; }
        
        .header-section { background: #fff; border-radius: 15px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .search-bar { width: 100%; padding: 15px; font-size: 16px; border: 2px solid #eee; border-radius: 12px; box-sizing: border-box; outline: none; }
        .search-bar:focus { border-color: var(--main-purple); box-shadow: 0 0 8px rgba(125, 107, 161, 0.1); }

        /* çµ±è¨ˆå€å¡Š */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 12px; margin-top: 15px; }
        .stat-item { background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 10px 5px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .stat-item img { width: 45px; height: 45px; border-radius: 50%; margin-bottom: 5px; border: 1px solid #f0f0f0; background: #fafafa; }
        .stat-name { font-size: 12px; font-weight: bold; margin-bottom: 5px; color: #444; }
        .stat-counts { font-size: 11px; display: flex; flex-direction: column; gap: 2px; }
        .count-gacha { color: var(--gacha-gold); font-weight: bold; }
        .count-reward { color: var(--reward-blue); font-weight: bold; }

        /* æ´»å‹•å¡ç‰‡å€ */
        .event-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 25px; }
        .event-card { background: #fff; border-radius: 15px; padding: 20px; border-top: 6px solid var(--main-purple); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .event-title { font-size: 1.25rem; font-weight: bold; color: var(--main-purple); margin-bottom: 8px; }
        .event-info { font-size: 13px; color: #888; margin-bottom: 15px; display: flex; justify-content: space-between; border-bottom: 1px solid #f4f4f4; padding-bottom: 10px; }
        
        .char-row { display: flex; align-items: center; margin-top: 10px; gap: 12px; padding: 8px; border-radius: 10px; }
        .bg-gacha { background: #fffcf0; border: 1px solid #fdf2d0; }
        .bg-reward { background: #f4f8ff; border: 1px solid #e1ecff; }
        
        .char-label { font-size: 11px; font-weight: bold; padding: 3px 8px; border-radius: 5px; color: #fff; min-width: 65px; text-align: center; }
        .lbl-leader { background: var(--main-purple); }
        .lbl-gacha { background: var(--gacha-gold); }
        .lbl-reward { background: var(--reward-blue); }

        .char-list { display: flex; flex-wrap: wrap; gap: 8px; }
        .char-img { width: 48px; height: 48px; border: 1px solid #ddd; border-radius: 8px; background: #fff; object-fit: cover; }
        
        h3 { margin: 0 0 15px 0; color: var(--main-purple); font-size: 1.3rem; border-left: 5px solid var(--main-purple); padding-left: 12px; }
        .loading { text-align: center; padding: 50px; font-size: 18px; color: var(--main-purple); }
    </style>
</head>
<body>

<div class="header-section">
    <input type="text" id="searchInput" class="search-bar" placeholder="ğŸ” æœå°‹æ´»å‹•åç¨±ã€è§’è‰²æ—¥æ–‡å..." oninput="handleSearch()">
    <div style="margin-top: 25px;">
        <h3>ğŸ“Š SSR å‡ºå¡æ¬¡æ•¸çµ±è¨ˆ</h3>
        <div id="statsGrid" class="stats-grid">è³‡æ–™è®€å–ä¸­...</div>
    </div>
</div>

<div id="eventList" class="event-grid">
    <div class="loading">æ­£åœ¨é€£ç·šè‡³ Google è©¦ç®—è¡¨...</div>
</div>

<script>
    // --- 1. åŸºç¤é…ç½® ---
    // è«‹ç¢ºä¿æ­¤ CSV ç¶²å€åŒ…å« gid=1107156854 (æ‚¨çš„ä¸»æ´»å‹•å·¥ä½œè¡¨)
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT_3vvzhb6VzcCYkVqberJIlPAeLIIWhWAIP1Oix6k3ItsBTclFSBXlXUCZIUsML82QiT-E7EScRAr6/pub?gid=1107156854&single=true&output=csv'; 
    const IMG_BASE_URL = 'https://mhyk-unofficial.github.io/mhyk_SSR_filter/mini_';

    // --- 2. è§’è‰²å°ç…§è¡¨ (å°æ‡‰æ‚¨çš„ gid=1685646816 è¡¨æ ¼å…§å®¹) ---
    const nameMap = {
        "ã‚ªã‚º": "Oz", "ã‚¢ãƒ¼ã‚µãƒ¼": "Arthur", "ã‚«ã‚¤ãƒ³": "Cain", "ãƒªã‚±": "Riquet",
        "ã‚¹ãƒã‚¦": "Snow", "ãƒ›ãƒ¯ã‚¤ãƒˆ": "White", "ãƒŸã‚¹ãƒ©": "Mithra", "ã‚ªãƒ¼ã‚¨ãƒ³": "Owen", "ãƒ–ãƒ©ãƒƒãƒ‰ãƒªãƒ¼": "Bradley",
        "ãƒ•ã‚¡ã‚¦ã‚¹ãƒˆ": "Faust", "ã‚·ãƒ": "Shino", "ãƒ’ãƒ¼ã‚¹ã‚¯ãƒªãƒ•": "Heathcliff", "ãƒãƒ­": "Nero",
        "ã‚·ãƒ£ã‚¤ãƒ­ãƒƒã‚¯": "Shylock", "ãƒ ãƒ«": "Murr", "ã‚¯ãƒ­ã‚¨": "Chloe", "ãƒ©ã‚¹ãƒ†ã‚£ã‚«": "Rustica",
        "ãƒ•ã‚£ã‚¬ãƒ­": "Figaro", "ãƒ«ãƒãƒ«": "Rutile", "ãƒ¬ãƒãƒƒã‚¯ã‚¹": "Lennox", "ãƒŸãƒãƒ«": "Mitile"
    };

    let allEvents = [];

    // å–å¾—åœ–ç‰‡ç¶²å€
    function getImgUrl(jpName) {
        if (!jpName) return `${IMG_BASE_URL}default.png`;
        const name = jpName.trim();
        const enName = nameMap[name] || "default"; 
        return `${IMG_BASE_URL}${enName}.png`;
    }

    // åˆ†éš”å­—ä¸²å·¥å…·
    function splitNames(str) {
        if (!str) return [];
        return str.split(/[,ï¼Œ\s/ã€\n]+/).filter(n => n.trim() !== "");
    }

    // --- 3. åˆå§‹åŒ– ---
    function init() {
        Papa.parse(CSV_URL, {
            download: true,
            header: true,
            complete: function(results) {
                // éæ¿¾ç©ºè¡Œ
                allEvents = results.data.filter(row => row['æ´»å‹•åç¨±'] && row['æ´»å‹•åç¨±'].trim() !== "");
                if(allEvents.length === 0) {
                    document.getElementById('eventList').innerHTML = "ç„¡æ³•è®€å–è³‡æ–™ï¼Œè«‹æª¢æŸ¥è©¦ç®—è¡¨ç™¼ä½ˆè¨­å®šã€‚";
                } else {
                    renderPage(allEvents);
                }
            },
            error: function() {
                document.getElementById('eventList').innerHTML = "é€£ç·šå¤±æ•—ã€‚";
            }
        });
    }

    function renderPage(data) {
        renderStats(data);
        renderEvents(data);
    }

    // --- 4. çµ±è¨ˆé‚è¼¯ (è‡ªå‹•è™•ç†é‡è¤‡æ¨™é¡Œæ¬„ä½) ---
    function renderStats(data) {
        let stats = {};
        Object.keys(nameMap).forEach(name => stats[name] = { gacha: 0, reward: 0 });

        data.forEach(item => {
            // éæ­·æ‰€æœ‰æ¬„ä½æ¨™é¡Œ
            Object.keys(item).forEach(key => {
                const val = item[key];
                const names = splitNames(val);

                // åªæœ‰ç•¶åå­—åœ¨ nameMap è£¡(æ—¥æ–‡å)æ‰çµ±è¨ˆï¼Œé¿é–‹ä¸­æ–‡æ¬„ä½
                if (key.includes("å¡æ± SSR")) {
                    names.forEach(n => { if(stats[n]) stats[n].gacha++; });
                } else if (key.includes("å ±é…¬SSR")) {
                    names.forEach(n => { if(stats[n]) stats[n].reward++; });
                }
            });
        });

        const sorted = Object.entries(stats).sort((a, b) => (b[1].gacha + b[1].reward) - (a[1].gacha + a[1].reward));

        document.getElementById('statsGrid').innerHTML = sorted.map(([jpName, count]) => `
            <div class="stat-item">
                <img src="${getImgUrl(jpName)}" onerror="this.src='https://via.placeholder.com/45?text=?'">
                <div class="stat-name">${jpName}</div>
                <div class="stat-counts">
                    <span class="count-gacha">æ± :${count.gacha}</span>
                    <span class="count-reward">è³:${count.reward}</span>
                </div>
            </div>
        `).join('');
    }

    // --- 5. æ¸²æŸ“æ´»å‹•å¡ç‰‡ ---
    function renderEvents(data) {
        const container = document.getElementById('eventList');
        container.innerHTML = data.map(item => {
            // æ”¶é›†æ‰€æœ‰æ¬„ä½ä¸­çš„ SSR
            let gachaList = [];
            let rewardList = [];
            
            Object.keys(item).forEach(key => {
                const names = splitNames(item[key]);
                // åªä¿ç•™åœ¨ nameMap è£¡çš„åå­—ï¼ˆéæ¿¾æ‰ä¸­æ–‡ï¼‰
                const validNames = names.filter(n => nameMap[n]);
                
                if (key.includes("å¡æ± SSR")) gachaList.push(...validNames);
                if (key.includes("å ±é…¬SSR")) rewardList.push(...validNames);
            });

            // ç§»é™¤é‡è¤‡é …
            gachaList = [...new Set(gachaList)];
            rewardList = [...new Set(rewardList)];

            return `
                <div class="event-card">
                    <div class="event-title">${item['æ´»å‹•åç¨±']}</div>
                    <div class="event-info">
                        <span>ç¬¬ ${item['æœŸæ•¸'] || '-'} æœŸ</span>
                        <span>ğŸ“… ${item['æ—¥æœŸ'] || '-'} (${item['å¤©æ•¸'] || '-'})</span>
                    </div>
                    
                    <div class="char-row">
                        <span class="char-label lbl-leader">çœ‹æ¿è§’è‰²</span>
                        <div class="char-list">
                            <img src="${getImgUrl(item['çœ‹æ¿è§’è‰²'])}" class="char-img" title="${item['çœ‹æ¿è§’è‰²']}">
                            <span style="font-size:13px; color:#555">${item['çœ‹æ¿è§’è‰²'] || ''}</span>
                        </div>
                    </div>

                    ${gachaList.length > 0 ? `
                    <div class="char-row bg-gacha">
                        <span class="char-label lbl-gacha">å¡æ±  SSR</span>
                        <div class="char-list">
                            ${gachaList.map(n => `<img src="${getImgUrl(n)}" class="char-img" title="${n}">`).join('')}
                        </div>
                    </div>` : ''}

                    ${rewardList.length > 0 ? `
                    <div class="char-row bg-reward">
                        <span class="char-label lbl-reward">å ±é…¬ SSR</span>
                        <div class="char-list">
                            ${rewardList.map(n => `<img src="${getImgUrl(n)}" class="char-img" title="${n}">`).join('')}
                        </div>
                    </div>` : ''}
                </div>
            `;
        }).join('');
    }

    // --- 6. æœå°‹é‚è¼¯ ---
    function handleSearch() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allEvents.filter(ev => 
            (ev['æ´»å‹•åç¨±'] || "").toLowerCase().includes(term) || 
            (ev['çœ‹æ¿è§’è‰²'] || "").toLowerCase().includes(term) ||
            (ev['å¡æ± SSR'] || "").toLowerCase().includes(term)
        );
        renderPage(filtered);
    }

    window.onload = init;
</script>
</body>
</html>