<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mhyk æ´»å‹•è³‡æ–™åº«</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root { 
            --main-purple: #7d6ba1; --gacha-gold: #d4af37; --reward-blue: #5b8ad2; 
            --sr-silver: #a0a0a0; --r-bronze: #cd7f32; --bg-color: #fcf9f2; 
        }
        body { font-family: "PingFang TC", sans-serif; background: var(--bg-color); margin: 0; padding: 20px; }
        .header-section { background: #fff; border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; margin-top: 15px; }
        .stat-item { background: #fff; border-radius: 10px; padding: 8px; text-align: center; border: 1px solid #eee; }
        .stat-item img { width: 40px; height: 40px; border-radius: 50%; }
        .stat-name { font-size: 11px; font-weight: bold; margin: 4px 0; }
        .stat-counts { font-size: 10px; line-height: 1.2; }
        
        .event-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 20px; }
        .event-card { background: #fff; border-radius: 12px; padding: 18px; border-top: 5px solid var(--main-purple); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .event-title { font-size: 1.2rem; font-weight: bold; color: var(--main-purple); margin-bottom: 5px; }
        .event-info { font-size: 12px; color: #888; display: flex; justify-content: space-between; margin-bottom: 12px; }
        
        .char-row { display: flex; align-items: center; margin-top: 8px; gap: 10px; padding: 6px 10px; border-radius: 8px; background: #fafafa; }
        .char-label { font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 4px; color: #fff; min-width: 60px; text-align: center; }
        .lbl-leader { background: var(--main-purple); }
        .lbl-ssr { background: var(--gacha-gold); }
        .lbl-sr { background: var(--sr-silver); }
        .lbl-r { background: var(--r-bronze); }
        .lbl-reward { background: var(--reward-blue); }
        .lbl-chibi { background: #666; }

        .char-list { display: flex; flex-wrap: wrap; gap: 5px; }
        .char-img { width: 42px; height: 42px; border-radius: 6px; border: 1px solid #ddd; background: #fff; }
        .chibi-img { width: 35px; height: 35px; border-radius: 4px; border: 1px solid #eee; filter: brightness(1.05); }
        
        .search-bar { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 10px; margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="header-section">
    <input type="text" id="searchInput" class="search-bar" placeholder="ğŸ” æœå°‹æ´»å‹•æˆ–è§’è‰²..." oninput="handleSearch()">
    <h3>ğŸ“Š å‡ºå¡çµ±è¨ˆ (SSR)</h3>
    <div id="statsGrid" class="stats-grid">è®€å–ä¸­...</div>
</div>

<div id="eventList" class="event-grid">è¼‰å…¥ä¸­...</div>

<script>
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT_3vvzhb6VzcCYkVqberJIlPAeLIIWhWAIP1Oix6k3ItsBTclFSBXlXUCZIUsML82QiT-E7EScRAr6/pub?gid=1107156854&single=true&output=csv';
    const IMG_BASE_URL = 'https://mhyk-unofficial.github.io/mhyk_SSR_filter/mini_';

    const nameMap = {
        "ã‚ªã‚º": "Oz", "ã‚¢ãƒ¼ã‚µãƒ¼": "Arthur", "ã‚«ã‚¤ãƒ³": "Cain", "ãƒªã‚±": "Riquet",
        "ã‚¹ãƒã‚¦": "Snow", "ãƒ›ãƒ¯ã‚¤ãƒˆ": "White", "ãƒŸã‚¹ãƒ©": "Mithra", "ã‚ªãƒ¼ã‚¨ãƒ³": "Owen", "ãƒ–ãƒ©ãƒƒãƒ‰ãƒªãƒ¼": "Bradley",
        "ãƒ•ã‚¡ã‚¦ã‚¹ãƒˆ": "Faust", "ã‚·ãƒ": "Shino", "ãƒ’ãƒ¼ã‚¹ã‚¯ãƒªãƒ•": "Heathcliff", "ãƒãƒ­": "Nero",
        "ã‚·ãƒ£ã‚¤ãƒ­ãƒƒã‚¯": "Shylock", "ãƒ ãƒ«": "Murr", "ã‚¯ãƒ­ã‚¨": "Chloe", "æ‹‰æ–¯æå¡": "Rustica",
        "ãƒ•ã‚£ã‚¬ãƒ­": "Figaro", "ãƒ«ãƒãƒ«": "Rutile", "ãƒ¬ãƒãƒƒã‚¯ã‚¹": "Lennox", "ãƒŸãƒãƒ«": "Mitile",
        "å¥§èŒ²": "Oz", "äºç‘Ÿ": "Arthur", "å‡±å› ": "Cain", "åˆ©å‡±": "Riquet",
        "æ€è«¾": "Snow", "æ‡·ç‰¹": "White", "å¯†æ–¯æ‹‰": "Mithra", "æ­æ–‡": "Owen", "å¸ƒæ‹‰å¾·åˆ©": "Bradley",
        "æµ®å£«å¾·": "Faust", "è¥¿è«¾": "Shino", "å¸Œæ–¯å…‹é‡Œå¤«": "Heathcliff", "å°¼æ´›": "Nero",
        "å¤æ´›å…‹": "Shylock", "å§†é­¯": "Murr", "åº«ç¾…è€¶": "Chloe", "æ‹‰æ–¯å ¤å¡": "Rustica",
        "è²»åŠ æ´›": "Figaro", "è·¯å¥‘çˆ¾": "Rutile", "é›·è«¾å…‹æ–¯": "Lennox", "ç±³å¥‘çˆ¾": "Mitile"
    };

    const idToJp = { "Oz": "ã‚ªã‚º", "Arthur": "ã‚¢ãƒ¼ã‚µãƒ¼", "Cain": "ã‚«ã‚¤ãƒ³", "Riquet": "ãƒªã‚±", "Snow": "ã‚¹ãƒã‚¦", "White": "ãƒ›ãƒ¯ã‚¤ãƒˆ", "Mithra": "ãƒŸã‚¹ãƒ©", "Owen": "ã‚ªãƒ¼ã‚¨ãƒ³", "Bradley": "ãƒ–ãƒ©ãƒƒãƒ‰ãƒªãƒ¼", "Faust": "ãƒ•ã‚¡ã‚¦ã‚¹ãƒˆ", "Shino": "ã‚·ãƒ", "Heathcliff": "ãƒ’ãƒ¼ã‚¹ã‚¯ãƒªãƒ•", "Nero": "ãƒãƒ­", "Shylock": "ã‚·ãƒ£ã‚¤ãƒ­ãƒƒã‚¯", "Murr": "ãƒ ãƒ«", "Chloe": "ã‚¯ãƒ­ã‚¨", "Rustica": "æ‹‰æ–¯æå¡", "Figaro": "ãƒ•ã‚£ã‚¬ãƒ­", "Rutile": "ãƒ«ãƒãƒ«", "Lennox": "ãƒ¬ãƒãƒƒã‚¯ã‚¹", "Mitile": "ãƒŸãƒãƒ«" };

    let allEvents = [];

    function splitNames(str) {
        if (!str) return [];
        return str.split(/[,ï¼Œ\s/ã€\n]+/).filter(n => n.trim() !== "");
    }

    function init() {
        Papa.parse(CSV_URL, {
            download: true, header: true,
            complete: function(results) {
                allEvents = results.data.filter(row => row['æ´»å‹•åç¨±']);
                renderPage(allEvents);
            }
        });
    }

    function renderPage(data) {
        renderStats(data);
        renderEvents(data);
    }

    function renderStats(data) {
        let stats = {};
        Object.values(nameMap).forEach(id => stats[id] = { gacha: 0, reward: 0 });
        data.forEach(item => {
            // ç›´æ¥ç”±åˆä½µå¾Œçš„æ¬„ä½çµ±è¨ˆ SSR
            const gachas = splitNames(item['å¡æ± ï¼³ï¼³ï¼²'] || item['å¡æ± SSR']);
            const rewards = splitNames(item['å ±é…¬ï¼³ï¼³ï¼²'] || item['å ±é…¬SSR']);
            
            gachas.forEach(n => { const id = nameMap[n.trim()]; if(id) stats[id].gacha++; });
            rewards.forEach(n => { const id = nameMap[n.trim()]; if(id) stats[id].reward++; });
        });
        const sorted = Object.entries(stats).sort((a, b) => (b[1].gacha + b[1].reward) - (a[1].gacha + a[1].reward));
        document.getElementById('statsGrid').innerHTML = sorted.map(([id, count]) => `
            <div class="stat-item">
                <img src="${IMG_BASE_URL}${id}.png">
                <div class="stat-name">${idToJp[id]}</div>
                <div class="stat-counts">
                    <span style="color:var(--gacha-gold)">æ± :${count.gacha}</span><br>
                    <span style="color:var(--reward-blue)">è³:${count.reward}</span>
                </div>
            </div>
        `).join('');
    }

    function renderEvents(data) {
        const container = document.getElementById('eventList');
        if (!data || data.length === 0) {
            container.innerHTML = "æ²’æœ‰æ‰¾åˆ°åŒ¹é…çš„æ´»å‹•è³‡æ–™ã€‚";
            return;
        }

        container.innerHTML = data.map(item => {
            // å·¥å…·ï¼šå–å¾—è©²æ¬„ä½çš„ ID Set
            const getIds = (fName) => new Set(splitNames(item[fName]).map(n => nameMap[n.trim()]).filter(id => id));

            const sets = {
                gSSR: getIds('å¡æ± ï¼³ï¼³ï¼²'),
                gSR:  getIds('å¡æ± ï¼³ï¼²'),
                gR:   getIds('å¡æ± ï¼²'),
                rSSR: getIds('å ±é…¬ï¼³ï¼³ï¼²'),
                rSR:  getIds('å ±é…¬ï¼³ï¼²'),
                rR:   getIds('å ±é…¬ï¼²'),
                chibi4: getIds('å››æ˜Ÿå°äºº'),
                chibi3: getIds('ä¸‰æ˜Ÿå°äºº')
            };

            const drawRow = (label, ids, colorClass, isChibi=false) => {
                if (!ids || ids.size === 0) return '';
                const imgClass = isChibi ? 'chibi-img' : 'char-img';
                return `
                    <div class="char-row">
                        <span class="char-label ${colorClass}">${label}</span>
                        <div class="char-list">
                            ${Array.from(ids).map(id => `<img src="${IMG_BASE_URL}${id}.png" class="${imgClass}" title="${idToJp[id] || id}" onerror="this.src='https://via.placeholder.com/40?text=?'">`).join('')}
                        </div>
                    </div>`;
            };

            const leaderId = nameMap[(item['çœ‹æ¿è§’è‰²'] || '').trim()];
            const combinedGachaSR = new Set([...sets.gSR, ...sets.gR]);
            const combinedRewardSR = new Set([...sets.rSR, ...sets.rR]);

            return `
                <div class="event-card">
                    <div class="event-title">${item['æ´»å‹•åç¨±'] || 'æœªå‘½åæ´»å‹•'}</div>
                    <div class="event-info">
                        <span>ç¬¬ ${item['æœŸæ•¸'] || '-'} æœŸ | ğŸ“… ${item['æ—¥æœŸ'] || '-'}</span>
                        <span>${item['å¤©æ•¸'] || ''}</span>
                    </div>
                    ${leaderId ? drawRow('çœ‹æ¿è§’è‰²', new Set([leaderId]), 'lbl-leader') : ''}
                    ${drawRow('å¡æ±  SSR', sets.gSSR, 'lbl-ssr')}
                    ${drawRow('å¡æ±  SR/R', combinedGachaSR, 'lbl-sr')}
                    ${drawRow('å ±é…¬ SSR', sets.rSSR, 'lbl-reward')}
                    ${drawRow('å ±é…¬ SR/R', combinedRewardSR, 'lbl-reward')}
                    ${drawRow('å››æ˜Ÿå°äºº', sets.chibi4, 'lbl-chibi', true)}
                    ${drawRow('ä¸‰æ˜Ÿå°äºº', sets.chibi3, 'lbl-chibi', true)}
                </div>`;
        }).join('');
    }

    function handleSearch() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allEvents.filter(ev => Object.values(ev).some(v => v.toLowerCase().includes(term)));
        renderPage(filtered);
    }
    window.onload = init;
</script>
</body>
</html>
